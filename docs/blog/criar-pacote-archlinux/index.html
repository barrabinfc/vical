<!doctype html>
<html lang="en">
  <head>
    <title>Como criar um pacote para &lt;b&gt;archlinux&lt;/b&gt;</title>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Criando pacotes para gerenciador pacman">
  
    <style>
  :root {
    --header-height: 96px;
    --front: #000;
    --back:  #fff;
    --gray:  #e9e9e9;
    --primary:     #f05553;
    --second:      #0098d8;
    --third:       #0b3536;

     
    --gutter:     0.5em; 
    --pad-margin:    calc( 8 * var(--gutter));

    --perfect-fifth: calc(3/2); 
    --major-third:   calc(5/4);
  
    --typoscale: var(--major-third);
    --linescale: var(--major-third);
  }

   
  @font-face {
    font-family: system;
    font-style: normal;
    font-weight: 300;
    src: local("-apple-system"), local("BlinkMacSystemFont"), local("Segoe UI"), local("Roboto"), local("Helvetica"), local("Arial"), local("sans-serif"), local("Apple Color Emoji"), local("Segoe UI Emoji"), local("Segoe UI Symbol");
  }

   
  *, *::after , *::before { box-sizing: border-box; }
  html,body { margin: 0; padding: 0; }
  body { 
    background-color: var(--back); 
    color: var(--front); 
    font-family: "system"; 
    overflow-x: hidden;
    overflow-y: overlay;
    
    text-rendering: optimizeLegibility;
    font-feature-settings: "kern" 1;
    overflow-wrap: break-word;
    max-width: 100vw;
    min-height: 100vh;  
  }
  iframe,embed,img,video,picture { max-width: 100%; object-fit: cover; }
  
  a,p,button { margin: 0; padding: 0; }
  blockquote { width: 100%; margin: 1em auto; line-height: 1.0em; }
  
  a { text-decoration: none; color: var(--second); }
  a:hover{ text-decoration: underline; }

  h1,h2,h3,h4,h5,h6 { 
    --size:  calc(1rem * 3.0 * var(--typoscale));
    
    font-family: system;
    font-size: var(--size);    
    line-height: calc( var(--size) + 0.75rem );
    margin: var(--size) 0;

    orphans: 2;
    widows: 2
  }

  h2 {  --size:  calc(1rem * 2.00 * var(--typoscale)); }
  h3 {  --size:  calc(1rem * 1.66 * var(--typoscale)); }
  h4 {  --size:  calc(1rem * 1.33 * var(--typoscale)); }
  h5 {  --size:  calc(1rem * 1.00 * var(--typoscale)); }
  h6 {  --size:  calc(1rem * 0.66 * var(--typoscale)); }

   
  p { 
    padding: 0;
    margin: 0;
    line-height: 1.625rem;

    orphans: 2;
    widows: 2;
  }

   
  p + * {
    margin-top: 1.5rem;
  }

   
  *:not(pre) > code {
    font-size: 85%;
    padding: var(--gutter);
    background-color: var(--gray);
    border-radius: 3px;
  }  
  
  .grid { display: flex; flex-wrap: wrap; }
  .grid.\:vertical { flex-direction: column; }
  .grid.\:middle { align-items: center; }
  .grid.\:top { align-items: flex-start; }
  .grid.\:bottom { align-items: flex-end; }
  .grid.\:baseline { align-items: baseline; }

  .grid.\:left  { justify-content: flex-start; }
  .grid.\:center  { justify-content: center; }
  .grid.\:right  { justify-content: flex-end; }
  .grid.\:between { justify-content: space-between; }
  .grid.\:around { justify-content: space-around; }

  .cell { flex: 1; }
  .cell.\:1of12 { flex: 0 0 8.33333%; }
  .cell.\:2of12 { flex: 0 0 16.66667%; }
  .cell.\:3of12 { flex: 0 0 25%; }
  .cell.\:4of12 { flex: 0 0 33.33333%; }
  .cell.\:5of12 { flex: 0 0 41.66667%; }
  .cell.\:6of12 { flex: 0 0 50%; }
  .cell.\:7of12 { flex: 0 0 58.33333%; }
  .cell.\:8of12 { flex: 0 0 66.66667%; }
  .cell.\:9of12 { flex: 0 0 75%; }
  .cell.\:10of12 { flex: 0 0 83.33333%; }
  .cell.\:11of12 { flex: 0 0 91.66667%; }
  .cell.\:12of12 { flex: 0 0 100%; }

  .nomargin { margin: 0 !important; padding: 0 !important; }
  .margin\:auto{ margin-left: auto !important; margin-right: auto !important; }
  .margin-vertical\:padded { margin-top: var(--pad-margin); margin-bottom: var(--pad-margin);}

  .float\:left { float: left !important; }
  .float\:right { float: right !important; }

  .pull\:left { margin-right: auto !important; }
  .pull\:right { margin-left: auto !important; }
  .align\:left { text-align: left !important; }
  .align\:right { text-align: right !important; }
  .align\:center { text-align: center !important; }

  .nounderscore:hover { text-decoration: none; }
  .uppercase { text-transform: uppercase !important; }
  .rounded { border-radius: 2em !important; }

  .w5  { max-width: 5%; width: 5%; }
  .w10 { max-width: 10%; width: 10%;}
  .w25 { max-width: 25%; width: 25%;}
  .w30 { max-width: 30%; width: 30%;}
  .w33 { max-width: 33%; width: 33%;}
  .w35 { max-width: 35%; width: 35%;}
  .w40 { max-width: 40%; width: 40%;}
  .w45 { max-width: 45%; width: 45%;}
  .w50 { max-width: 50%; width: 60%;}
  .w60 { max-width: 60%; width: 60%;}
  .w65 { max-width: 60%; width: 65%;}
  .w66 { max-width: 66%; width: 66%;}
  .w70 { max-width: 70%; width: 70%;}
  .w75 { max-width: 75%; width: 75%;}
  .w80 { max-width: 80%; width: 80%;}
  .w85 { max-width: 85%; width: 85%; }
  .w90 { max-width: 90%; width: 90%;}
  .w100 { max-width: 100%; width: 100%; }

   
  .intrinsic {
    display: block;
    position: relative;
    width: 100%;
  }
  .intrinsic__item.\:square { width: 100%; height: 100%; }
  .intrinsic__item.\:4x3 { width: 100%; height: calc( (100% / 4) * 3 ); }
  .intrinsic__item.\:16x9 { width: 100%; height: calc( (100% / 16) * 9); }
  .intrinsic > .intrinsic__item {
    background: var(--gray);
  } 


  .img\:avatar {
    width: 225px;
    height: 225px;
    margin: 0 auto; 
    border-radius: 50%; overflow: hidden;
    border: 1px solid var(--gray);
    object-fit: cover ;
  }

   
  ul.clean , ol.clean {
    list-style: none;
    counter-reset: none;
    margin: 0; padding-left: 0;
  } 
  ul.clean li, ol.clean li { margin: 0; }
  ul.clean li::before , ol.clean li::before {
      content: '';
      display: none;
  }

   
  .icon {
    display: inline-block;
    width: 25px; height: 25px;
    overflow: hidden; fill: currentColor;
  }
  .icon__cnt {
    width: 100%; height: 100%;
    background: inherit;
    fill: inherit;
    pointer-events: none; 
    transform: translateX(0); 
    -ms-transform: translate(0.5px, -0.3px);
  }
  .icon--m {
    width: 50px;
    height: 50px;
    top: 18px;
  }

   
  .card {
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-evenly;

    height: 200px;
    overflow: hidden;
    color: inherit;
    border-radius: 15px;
    background-color: var(--gray);

    padding: 0rem;
  }



   
  body > header {
    width: 100%;
    height: var(--header-height);
    margin: 0;
    padding: 0 var(--pad-margin);
    border-bottom: 1px solid var(--gray);
  }
  body > header > .logo-container { flex: 0.2; }
  body > header > .logo-container .logo { font-size: 2em; font-weight: bold; color: var(--front); }
  body > header > .menu > .menu-header {
    padding: 1rem;
    text-transform: uppercase;
    text-align: center;
  }

   
  #page-trans-wrapper {
    perspective: var(--perspective);
    transform-style:  preserve-3d;
  }
  .page-container  {
    width: 100%;
    transform: translate3d(0,0,0);
  }

   
  body > footer {
    width: 100%;
    height: var(--header-height);
    margin: 0;
    padding: 0 var(--pad-margin);
    border-top: 1px solid var(--gray);
    color: var(--front );
  }
  body > footer > ul  { width: 100%; height: inherit; list-style: none; }
  body > footer > ul li { flex: 0.2; }
  body > footer a {
    color: var(--third); 
  }


   
  .page-container > section {  
    position: relative; 
    width: 100%;
  }

  .page-container > section > article:first-child {
    height: 100%;
    padding-top: 2em;  
  }
  
  .js-tilt-glare { pointer-events: none; }
</style>
        
  </head>  
  
  <body class="">

    
    <header class="grid :middle :between " id="menu">
      
<div class="logo-container">
  <a href="/" class="logo no-hover" id="logo">
  vical
</a>
</div>


<nav class="menu grid :end ">

  
    
    

    <a class="menu-header animated
             "
        href="/projects/"
        id="menu-projects">
        projects
      </a>
  
    
    

    <a class="menu-header animated
             "
        href="/about/me"
        id="menu-about">
        About
      </a>
  
    
    

    <a class="menu-header animated
             selected"
        href="/blog/"
        id="menu-blog">
        Blog
      </a>
  

</nav>
 

    </header>

    
    <main id="page-trans-wrapper">
      <div id="page-container" class="page-container blog ">
        
<section class="post">
  
  <article id="post__showcase" class="anim appearFromBottom 
                                      
                                      ">
    <picture>
      
    </picture>
    <div class="headline">
      <h1 class="title">Como criar um pacote para <b>archlinux</b></h1>
      <h3 class="subtitle"></h3>
    </div>
  </article>

  <article id="post__body" class="margin:auto grid :vertical :around">
      <div id="post__meta" class="meta">
          <div class="author">
            <h4 class="avatar">Vitor Calejuri</h4>
          </div>
          <div class="categories">
              
                <span class="tags">archlinux</span>
                <span class="tags">pacman</span>
                <span class="tags">recipe</span>
            
          </div>
    
          <div class="date">
              
                <time datetime="2017-07-15 00:00:00 &#43;0000 UTC">
                    July
                    15,
                    2017                
                </time>
              
    
          </div>
      </div>
      <div id="post__body__content">
          <p>Archlinux é uma das melhores distribuições Linux em 2018. Entretanto, a quantidade de software no catálogo ainda é inferior ao ubuntu,
e eventualmente você vai ter que instalar software manualmente.</p>

<p>Nesses casos, é muito útil saber como empacotar software. Dessa forma,
ainda podemos gerênciar instalação/atualizações/remoção usando o <strong>pacman</strong>, sem termos
software zumbi no sistema operacional.</p>

<p>Nesse artigo, vou mostrar como empacotar o software <a href="https://github.com/kornelski/giflossy">giflossy</a>, um otimizador lossy de gifs.</p>

<p></p>

<h3 id="instalando-o-giflossy-manualmente">Instalando o <code>giflossy</code> manualmente</h3>

<p>O primeiro passo, é compilar e instalar o software manualmente. Vamos baixar o Giflossy diretamente do <code>git</code> e instalar.</p>

<pre><code>$ git clone https://github.com/pornel/giflossy
$ cd giflossy
$ autoreconf -i
$ ./configure
$ make
$ make install
</code></pre>

<p>O software compilou e instalou sem problemas. Vamos prosseguir e empacotar.</p>

<h3 id="criando-o-pacote">Criando o pacote</h3>

<p>Para criar o pacote, criamos um arquivo de receita chamado <strong>PKGBUILD</strong> . Cada gerenciador
de pacotes tem seu proprio formato de receita, alguns bastante burocráticos. Felizmente,
o pacman usa simples <em>bash</em> scripts, concisos e direto ao ponto.</p>

<p>Após a receita descrita, preparamos o pacote usando o programa <code>makepkg</code>, gerando um pacote no formato <em>tar.xz</em>.
Este pacote pode ser distribuido,e se instala diretamente através do pacman: <code>pacman -U &lt;pacote&gt;</code></p>

<pre><code>mkdir -o ~/Desktop/giflossy-pkg
cd ~/Desktop/giflossy-pkg
cp /usr/share/pacman/PKGBUILD.proto PKGBUILD
</code></pre>

<p>Vamos preencher a receita com as informações do software, como descrição, nome, licensa e versão.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Maintainer: vical &lt;barrabin.fc@gmail.com&gt;
</span><span style="color:#75715e"></span>pkgname<span style="color:#f92672">=</span>giflossy
pkgver<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>.89
pkgrel<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
epoch<span style="color:#f92672">=</span>
pkgdesc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Lossy GIF compressor ( fork of gifsicle)&#34;</span>
arch<span style="color:#f92672">=(</span><span style="color:#e6db74">&#39;x86_64&#39;</span><span style="color:#f92672">)</span>
url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://github.com/pornel/giflossy&#34;</span>
license<span style="color:#f92672">=(</span><span style="color:#e6db74">&#39;GPL&#39;</span><span style="color:#f92672">)</span>
groups<span style="color:#f92672">=()</span>
depends<span style="color:#f92672">=()</span>
makedepends<span style="color:#f92672">=()</span>
checkdepends<span style="color:#f92672">=()</span>
optdepends<span style="color:#f92672">=()</span>
provides<span style="color:#f92672">=()</span>
conflicts<span style="color:#f92672">=()</span>
replaces<span style="color:#f92672">=()</span>
backup<span style="color:#f92672">=()</span>
options<span style="color:#f92672">=()</span>
install<span style="color:#f92672">=</span>
changelog<span style="color:#f92672">=</span>
source<span style="color:#f92672">=(</span><span style="color:#e6db74">&#34;https://github.com/pornel/giflossy/archive/master.zip&#34;</span><span style="color:#f92672">)</span>
noextract<span style="color:#f92672">=()</span>
md5sums<span style="color:#f92672">=(</span><span style="color:#e6db74">&#34;f37da4b0730a38778fa5901a80aa9636&#34;</span><span style="color:#f92672">)</span>
validpgpkeys<span style="color:#f92672">=()</span>

prepare<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    cd <span style="color:#e6db74">&#34;</span>$pkgname<span style="color:#e6db74">-master&#34;</span>
    autoreconf -i
<span style="color:#f92672">}</span>

build<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    cd <span style="color:#e6db74">&#34;</span>$pkgname<span style="color:#e6db74">-master&#34;</span>
    ./configure --prefix<span style="color:#f92672">=</span>/usr
    make
<span style="color:#f92672">}</span>

check<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    cd <span style="color:#e6db74">&#34;</span>$pkgname<span style="color:#e6db74">-master&#34;</span>
    make -k check
<span style="color:#f92672">}</span>

package<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    cd <span style="color:#e6db74">&#34;</span>$pkgname<span style="color:#e6db74">-master&#34;</span>
    make DESTDIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$pkgdir<span style="color:#e6db74">/&#34;</span> install
<span style="color:#f92672">}</span></code></pre></div>
<p>As funções essenciais ao processo são <code>prepare()</code>, <code>build()</code> e <code>package()</code>. Elas devem estar presentes, mesmo se vazias. Rode o processo de compilação na funcão <code>build</code>.</p>

<blockquote>
<p><strong>Atenção</strong></p>

<p>Por razões de integridade e segurança, é sempre necessário colocar o md5sum do pacote</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ md5sum master.zip
f37da4b0730a38778fa5901a80aa9636  master.zip
$</code></pre></div></blockquote>

<p>Com a receita pronta, vamos rodar o programa <code>makepkg</code>, que irá gerar o pacote <strong>giflossy-1.89-1-x86_64.pkg.tar</strong>.</p>

<p>Podemos preparar o pacote quantas vezes for necessário, ajustando e adaptando a receita até estar perfeita.</p>

<h3 id="validando-o-pacote">Validando o pacote</h3>

<p>Embora o pacote esteja pronto, pode ainda conter alguns erros. Um deles, no nosso caso, é que esquecemos de
declarar uma dependencia. A ferramenta <code>namcap</code> ajuda nesse processo de encontrar erros:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ namcap PKGBUILD
$ namcap &lt;pacote&gt;.tar.xz
giflossy E: Dependency libx11 detected and not included <span style="color:#f92672">(</span>libraries <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;usr/lib/libX11.so.6&#39;</span><span style="color:#f92672">]</span> needed in files <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;usr/bin/gifview&#39;</span><span style="color:#f92672">])</span></code></pre></div>
<p>Ótimo! Podemos voltar ao nosso PKGBUILD e corrigir , declarando as dependencias que faltam e criando de novo o pacote</p>

<pre><code>depends=(&quot;libx11&quot;)
</code></pre>

<p>E por fim, podemos instalar.</p>

<dl>
<dt>Instalação</dt>
<dd><code>pacman -U &lt;pacote&gt;.tar.xz</code></dd>
<dt>Remoção</dt>
<dd><code>pacman -R giflossy</code></dd>
</dl>

<hr />

<blockquote>
<p><strong>Pacotes baixados através do git</strong></p>

<p>Como nosso pacote é baixado através do git, a versão do pacote
pode não ser a versão que é baixada do git.
Nesses casos, fazemos <a href="https://wiki.archlinux.org/index.php/VCS_package_guidelines#The_pkgver.28.29_function">autobump de versão</a></p>

<p>Para isso, sobrescrevemos a função <code>pkgver()</code>, que deve retornar uma string com a versão do software.
No nosso caso, vamos ler a versão do arquivo <strong>NEWS</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pkgver<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  cd <span style="color:#e6db74">&#34;</span>$pkgname<span style="color:#e6db74">-master&#34;</span>
  head NEWS | grep Version | awk <span style="color:#e6db74">&#39;{print $2}&#39;</span>
<span style="color:#f92672">}</span></code></pre></div>
<p>Pronto! Agora o pacote é sempre atualizado do git.</p>
</blockquote>
      </div>
  </article>
</section>

      </div>
    </main>
    <footer id="footer" class="grid :middle :between"> 
<ul class="grid :horizontal :middle clean">
    <li>
        <div class="title">Contact</div>
        <a href="" peculiarity="link-encrypted" data="ymuxfa:hufad.omvgxqdu@symux.oay">
            <span class="ceasar says">hufad.omvgxqdu@symux.oay</span>
        </a>
    </li>
    <li>
        <div class="title">Social</div>
        <a href="http://github.com/barrabinfc">Github</a>
    </li>
    <li class="align:right pull:right">
        <a href="http://github.com/barrabinfc" class="icon icon--m">
            <svg class="icon__cnt"><use xlink:href="/images/_svgicons.svg#ei-sc-github-icon"></use></svg>
            Github
        </a>
        <a href="" peculiarity="link-encrypted" data="ymuxfa:hufad.omvgxqdu@symux.oay" class="icon icon--m">
            <svg class="icon__cnt"><use xlink:href="/images/_svgicons.svg#ei-envelope-icon"></use></svg>
            <span class="ceasar says">hufad.omvgxqdu@symux.oay</span>
        </a>
    </li>
</ul> 
<style>
      
</style>
 
</footer>

    <link rel="stylesheet" href="/css/main.css">

    
    <script src="/js/app.js" defer></script>
    <script type="text/javascript" src="/js/vendor/vanilla-tilt.babel.min.js" defer></script>  
    
  </body>
</html>
